var _createClass=(()=>{function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}})();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}jQuery(document).ready(function(l){function t(e){var i=this;_classCallCheck(this,t),this.order_id=e.order_id,this.ajax_url=e.ajax_url,this.logging_enabled=e.logging_enabled,this.setup_action=e.setup_action,this.setup_nonce=e.setup_nonce,this.check_enrollment_action=e.check_enrollment_action,this.check_enrollment_nonce=e.check_enrollment_nonce,this.enabled_card_types=e.enabled_card_types,this.enabled_card_type_names=e.enabled_card_type_names,this.i18n=e.i18n,this.has_validated=!1,l(document.body).on("wc_cybersource_flex_form_submitted",function(e,t){i.handler=t.payment_form;var t=i.handler.card_type,n=i.enabled_card_types;return i.handler.saved_payment_method_selected&&(t=i.handler.form.find("input#wc-cybersource-credit-card-payment-token-"+i.handler.saved_payment_method_selected).data("card-type"),n=i.enabled_card_type_names),!n.includes(t)||!!i.has_validated||(i.token=i.handler.jti,i.handler.saved_payment_method_selected?i.setup(i.handler.saved_payment_method_selected,!1):i.setup(i.token,!0),!1)})}window.WC_Cybersource_ThreeD_Secure_Handler=(_createClass(t,[{key:"collect_device_information",value:function(e,t){var n=this,i=new URL(e),a=(this.log("Collecting Device Data"),function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;window.removeEventListener("message",o),d&&clearTimeout(d),e&&n.log(e),n.check_enrollment()}),o=function(e){e.origin===i.origin&&e.source===c&&(n.log("Device Data collection complete"),a(e.data))},r=(window.addEventListener("message",o,!1),l("#cardinal_device_data_collection")),c=(r.length||(r=l('\n\t\t\t\t\t<div id="cardinal_device_data_collection">\n\t\t\t\t\t\t<iframe id="cardinal_collection_iframe" name="collectionIframe" height="10" width="10" style="display:none;"></iframe>\n\t\t\t\t\t\t<form id="cardinal_collection_form" method="POST" target="collectionIframe" action="">\n\t\t\t\t\t\t\t<input id="cardinal_collection_form_input" type="hidden" name="JWT" />\n\t\t\t\t\t\t</form>\n\t\t\t\t\t</div>\n\t\t\t\t'),l(document.body).append(r)),r.find("#cardinal_collection_form_input").val(t),r.find("#cardinal_collection_form").prop("action",e).submit(),r.find("#cardinal_collection_iframe")[0].contentWindow),d=setTimeout(function(){n.log("Device Data collection timed out"),a()},1e4)}},{key:"setup",value:function(e,t){var n=this;this.log("Setting up Payer Authentication"),l.post(this.ajax_url,{order_id:this.order_id,action:this.setup_action,nonce:this.setup_nonce,token:e,is_transient:t},function(e){e.success&&e.data&&e.data.jwt?(n.log("Payer Authentication setup complete"),n.reference_id=e.data.reference_id,n.collect_device_information(e.data.device_data_collection_url,e.data.jwt)):(n.log("JWT is missing","error"),n.handler.render_errors([n.i18n.error_general]))}).fail(function(e){n.handle_ajax_error(e)})}},{key:"check_enrollment",value:function(){var n=this,e=(this.log("Checking enrollment"),this.handler.saved_payment_method_selected||this.token),t=!this.handler.saved_payment_method_selected;l.post(this.ajax_url,{order_id:this.order_id,reference_id:this.reference_id,action:this.check_enrollment_action,nonce:this.check_enrollment_nonce,token:e,expiration_month:this.handler.card_expiration_month,expiration_year:this.handler.card_expiration_year,is_transient:t,device_data:this.collect_backup_device_data()},function(e){var t;e.success&&e.data&&e.data.consumerAuthenticationInformation?(t=e.data.consumerAuthenticationInformation).stepUpUrl?(n.log("Step-up URL provided, present challenge"),n.present_challenge(t)):(n.log("No Step-Up URL, submitting form"),n.submit()):(n.log(e),t=e.data.length?e.data.map(function(e){return e.message}):[n.i18n.error_general],n.handler.render_errors(t))}).fail(function(e){n.handle_ajax_error(e)})}},{key:"present_challenge",value:function(e){var t=this,n=(this.log("Presenting 3DS challenge"),JSON.parse(atob(e.pareq))),i=e.stepUpUrl,e=e.accessToken,n=this.get_challenge_window_dimensions(n.challengeWindowSize||"05"),a=(window.addEventListener("message",function(e){e.origin===window.location.origin&&e.source===o&&(t.log("Step-up challenge complete"),l(document.body).css("overflow","auto"),console.log(e.data),a.hide(),t.submit())},!1),l("#wc-cybersource-3ds-challenge")),o=(a.length||(a=l('\n\t\t\t\t\t<div id="wc-cybersource-3ds-challenge">\n\t\t\t\t\t\t<div class="modal">\n\t\t\t\t\t\t\t<iframe name="step-up-iframe" id="step-up-iframe"></iframe>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<form id="step-up-form" target="step-up-iframe" method="post">\n\t\t\t\t\t\t\t<input type="hidden" name="JWT" id="step-up-token" />\n\t\t\t\t\t\t</form>\n\t\t\t\t\t</div>\n\t\t\t\t'),l(document.body).append(a)),l(document.body).css("overflow","hidden"),a.find("#step-up-iframe").width(n.width).height(n.height),a.find("#step-up-token").val(e),a.find("#step-up-form").prop("action",i).submit(),a.show(),a.find("#step-up-iframe")[0].contentWindow)}},{key:"submit",value:function(){this.log("Payer Authentication complete, submitting form for payment authorization"),this.has_validated=!0,this.handler.form.submit()}},{key:"handle_ajax_error",value:function(e){this.log(e.responseJSON.data||"Unknown error","error"),this.handler.render_errors([this.i18n.error_general])}},{key:"log",value:function(e){this.logging_enabled&&("error"===(1<arguments.length&&void 0!==arguments[1]?arguments[1]:"")?console.error(e):console.log(e))}},{key:"collect_backup_device_data",value:function(){return{httpBrowserColorDepth:window.screen.colorDepth,httpBrowserJavaEnabled:window.navigator.javaEnabled(),httpBrowserJavaScriptEnabled:!0,httpBrowserLanguage:window.navigator.language,httpBrowserScreenHeight:window.screen.height,httpBrowserScreenWidth:window.screen.width,httpBrowserTimeDifference:(new Date).getTimezoneOffset()}}},{key:"get_challenge_window_dimensions",value:function(e){return{"01":{width:250,height:400},"02":{width:390,height:400},"03":{width:500,height:600},"04":{width:600,height:400},"05":{width:1e3,height:600}}[e]}}]),t)});