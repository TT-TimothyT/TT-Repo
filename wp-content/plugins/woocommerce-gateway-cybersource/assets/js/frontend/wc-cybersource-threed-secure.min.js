"use strict";var _createClass=function(){function n(e,r){for(var a=0;a<r.length;a++){var n=r[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,r,a){return r&&n(e.prototype,r),a&&n(e,a),e}}();function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}jQuery(document).ready(function(t){function r(e){var n=this;_classCallCheck(this,r),this.order_id=e.order_id,this.ajax_url=e.ajax_url,this.logging_enabled=e.logging_enabled,this.setup_action=e.setup_action,this.setup_nonce=e.setup_nonce,this.check_enrollment_action=e.check_enrollment_action,this.check_enrollment_nonce=e.check_enrollment_nonce,this.enabled_card_types=e.enabled_card_types,this.enabled_card_type_names=e.enabled_card_type_names,this.i18n=e.i18n,this.logging_enabled&&Cardinal.configure({logging:{level:"on"}}),Cardinal.on("payments.setupComplete",function(e){var r=n.handler.card_number;n.handler.saved_payment_method_selected&&(r=n.handler.form.find("input#wc-cybersource-credit-card-payment-token-"+n.handler.saved_payment_method_selected).data("card-bin").toString()),Cardinal.trigger("bin.process",r.substring(0,6)).then(function(e){e.Status?(n.log("BIN detection successful"),n.handler.saved_payment_method_selected?n.check_enrollment(n.handler.saved_payment_method_selected,!1):n.check_enrollment(n.token,!0)):(n.log("BIN detection failed","error"),n.handler.render_errors([n.i18n.error_general])),n.log(e)})}),Cardinal.on("payments.validated",function(e,r){n.validate_results(e,r)}),this.has_validated=!1,t(document.body).on("wc_cybersource_flex_form_submitted",function(e,r){n.handler=r.payment_form;var r=n.handler.card_type,a=n.enabled_card_types;return n.handler.saved_payment_method_selected&&(r=n.handler.form.find("input#wc-cybersource-credit-card-payment-token-"+n.handler.saved_payment_method_selected).data("card-type"),a=n.enabled_card_type_names),!a.includes(r)||!!n.has_validated||(n.token=n.handler.jti,n.handler.saved_payment_method_selected?n.setup(n.handler.saved_payment_method_selected,!1):n.setup(n.token,!0),!1)})}window.WC_Cybersource_ThreeD_Secure_Handler=(_createClass(r,[{key:"setup",value:function(e,r){var a=this;t.post(this.ajax_url,{order_id:this.order_id,action:this.setup_action,nonce:this.setup_nonce,token:e,is_transient:r},function(e){e.success&&e.data&&e.data.jwt?(a.reference_id=e.data.reference_id,Cardinal.setup("init",{jwt:e.data.jwt})):(a.log("JWT is missing","error"),a.handler.render_errors([a.i18n.error_general]))}).fail(function(e){a.handle_ajax_error(e)})}},{key:"check_enrollment",value:function(e,r){var a=this;t.post(this.ajax_url,{order_id:this.order_id,reference_id:this.reference_id,action:this.check_enrollment_action,nonce:this.check_enrollment_nonce,token:e,is_transient:r},function(e){e.success&&e.data&&e.data.order?(a.handler.form.find("#wc_cybersource_threed_secure_ecommerce_indicator").val(e.data.order.OrderDetails.ecommerceIndicator),a.handler.form.find("#wc_cybersource_threed_secure_ucaf_collection_indicator").val(e.data.order.OrderDetails.ucafCollectionIndicator),a.handler.form.find("#wc_cybersource_threed_secure_cavv").val(e.data.order.OrderDetails.cavv),a.handler.form.find("#wc_cybersource_threed_secure_ucaf_authentication_data").val(e.data.order.OrderDetails.ucafAuthenticationData),a.handler.form.find("#wc_cybersource_threed_secure_xid").val(e.data.order.OrderDetails.xid),a.handler.form.find("#wc_cybersource_threed_secure_veres_enrolled").val(e.data.order.OrderDetails.veresEnrolled),a.handler.form.find("#wc_cybersource_threed_secure_specification_version").val(e.data.order.OrderDetails.specificationVersion),a.handler.form.find("#wc_cybersource_threed_secure_directory_server_transaction_id").val(e.data.order.OrderDetails.directoryServerTransactionId),a.handler.form.find("#wc_cybersource_threed_secure_card_type").val(e.data.order.OrderDetails.cardType),e.data.continue&&e.data.continue.AcsUrl?(a.log("calling Cardinal.continue()"),Cardinal.continue("cca",e.data.continue,e.data.order)):(a.log("No ACS URL, submitting form"),a.set_transaction_id(e.data.order.OrderDetails.TransactionId),a.set_reference_id(a.reference_id),a.has_validated=!0,a.handler.form.submit())):(a.log("Invalid data","error"),a.log(e),a.handler.render_errors([a.i18n.error_general]))}).fail(function(e){a.handle_ajax_error(e)})}},{key:"validate_results",value:function(e,r){this.set_transaction_id(e.Payment.ProcessorTransactionId),this.set_reference_id(this.reference_id),this.handler.form.find("#wc_cybersource_threed_secure_eci_flag").val(e.Payment.ExtendedData.ECIFlag),e.Payment.ExtendedData.CAVV&&this.handler.form.find("#wc_cybersource_threed_secure_cavv").val(e.Payment.ExtendedData.CAVV),this.handler.form.find("#wc_cybersource_threed_secure_jwt").val(r),this.has_validated=!0,this.handler.form.submit()}},{key:"set_transaction_id",value:function(e){this.handler.form.find("#wc_cybersource_threed_secure_transaction_id").val(e)}},{key:"set_reference_id",value:function(e){this.handler.form.find("#wc_cybersource_threed_secure_reference_id").val(e)}},{key:"handle_ajax_error",value:function(e){this.log(e.responseJSON.data||"Unknown error","error"),this.handler.render_errors([this.i18n.error_general])}},{key:"log",value:function(e){this.logging_enabled&&("error"===(1<arguments.length&&void 0!==arguments[1]?arguments[1]:"")?console.error(e):console.log(e))}}]),r)});