"use strict";var _createClass=function(){function t(e,n){for(var r=0;r<n.length;r++){var t=n[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}jQuery(document).ready(function(t){function n(e){var r=this;_classCallCheck(this,n),this.order_id=e.order_id,this.ajax_url=e.ajax_url,this.logging_enabled=e.logging_enabled,this.setup_action=e.setup_action,this.setup_nonce=e.setup_nonce,this.check_enrollment_action=e.check_enrollment_action,this.check_enrollment_nonce=e.check_enrollment_nonce,this.enabled_card_types=e.enabled_card_types,this.i18n=e.i18n,this.logging_enabled&&Cardinal.configure({logging:{level:"on"}}),Cardinal.on("payments.setupComplete",function(e){Cardinal.trigger("bin.process",r.handler.card_number.substring(0,6)).then(function(e){e.Status?(r.log("BIN detection successful"),r.check_enrollment(r.token)):(r.log("BIN detection failed","error"),r.handler.render_errors([r.i18n.error_general])),r.log(e)})}),Cardinal.on("payments.validated",function(e,n){r.validate_results(e,n)}),this.has_validated=!1,t(document.body).on("wc_cybersource_flex_form_submitted",function(e,n){return r.handler=n.payment_form,!!r.handler.form.saved_payment_method_selected||(!r.enabled_card_types.includes(r.handler.card_type)||(!!r.has_validated||(r.token=r.handler.jti,r.setup(r.token),!1)))})}window.WC_Cybersource_ThreeD_Secure_Handler=(_createClass(n,[{key:"setup",value:function(e){var n=this;t.post(this.ajax_url,{order_id:this.order_id,action:this.setup_action,nonce:this.setup_nonce,token:e},function(e){e.success&&e.data&&e.data.jwt?(n.reference_id=e.data.reference_id,Cardinal.setup("init",{jwt:e.data.jwt})):(n.log("JWT is missing","error"),n.handler.render_errors([n.i18n.error_general]))}).fail(function(e){n.handle_ajax_error(e)})}},{key:"check_enrollment",value:function(e){var n=this;t.post(this.ajax_url,{order_id:this.order_id,reference_id:this.reference_id,action:this.check_enrollment_action,nonce:this.check_enrollment_nonce,token:e},function(e){e.success&&e.data&&e.data.order?e.data.continue&&e.data.continue.AcsUrl?(n.log("calling Cardinal.continue()"),Cardinal.continue("cca",e.data.continue,e.data.order)):(n.log("No ACS URL, submitting form"),n.set_transaction_id(e.data.order.OrderDetails.TransactionId),n.set_reference_id(n.reference_id),n.has_validated=!0,n.handler.form.submit()):(n.log("Invalid data","error"),n.log(e),n.handler.render_errors([n.i18n.error_general]))}).fail(function(e){n.handle_ajax_error(e)})}},{key:"validate_results",value:function(e,n){this.set_transaction_id(e.Payment.ProcessorTransactionId),this.set_reference_id(this.reference_id),this.handler.form.find("#wc_cybersource_threed_secure_jwt").val(n),this.has_validated=!0,this.handler.form.submit()}},{key:"set_transaction_id",value:function(e){this.handler.form.find("#wc_cybersource_threed_secure_transaction_id").val(e)}},{key:"set_reference_id",value:function(e){this.handler.form.find("#wc_cybersource_threed_secure_reference_id").val(e)}},{key:"handle_ajax_error",value:function(e){this.log(e.responseJSON.data||"Unknown error","error"),this.handler.render_errors([this.i18n.error_general])}},{key:"log",value:function(e){this.logging_enabled&&("error"===(1<arguments.length&&void 0!==arguments[1]?arguments[1]:"")?console.error(e):console.log(e))}}]),n)});